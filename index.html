<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Solar Potential – Greece (Clean Build)</title>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/deck.gl@8.9.34/dist.min.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
#map { width:100vw; height:100vh; }

.panel {
  position:absolute;
  background:rgba(15,15,15,0.95);
  color:#ddd;
  padding:14px;
  border-radius:4px;
  font-size:13px;
  z-index:10;
}

#legend { bottom:20px; left:20px; width:260px; }

.legend-gradient {
  height:14px;
  background: linear-gradient(to right, #1e90ff, #ffff00, #ff4500);
  margin:10px 0;
  border-radius:3px;
}

h3 { margin:0 0 6px 0; color:#fff; font-size:15px; }
</style>
</head>

<body>

<div id="map"></div>

<div id="legend" class="panel">
  <h3>Solar Irradiation (Demo)</h3>
  <div class="legend-gradient"></div>
  <div>Low → High</div>
</div>

<script>

const MAPTILER_KEY = "fmHz7ZycUzBddOZvkGZO";

const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/basic-dark/style.json?key=${MAPTILER_KEY}`,
  center: [22.5, 39.0],
  zoom: 6.2,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

map.on('load', () => {

  // ------------------------------------------------------------
  // REMOVE DEFAULT BUILDING LAYERS (IMPORTANT)
  // ------------------------------------------------------------

  const layers = map.getStyle().layers;

  layers.forEach(layer => {
    if (layer['source-layer'] === 'building') {
      map.removeLayer(layer.id);
    }
  });

  // ------------------------------------------------------------
  // ADD OUR OWN 3D BUILDINGS (HIGH CONTRAST)
  // ------------------------------------------------------------

  map.addLayer({
    id: 'custom-buildings',
    type: 'fill-extrusion',
    source: 'openmaptiles',
    'source-layer': 'building',
    minzoom: 13,
    paint: {
      'fill-extrusion-color': '#ffffff',

      'fill-extrusion-height': [
        'case',
        ['has', 'height'], ['get', 'height'],
        ['has', 'levels'], ['*', ['get', 'levels'], 5],
        25
      ],

      'fill-extrusion-base': 0,
      'fill-extrusion-opacity': 0.95
    }
  });

  // ------------------------------------------------------------
  // STRONG LIGHTING
  // ------------------------------------------------------------

  map.setLight({
    anchor: 'viewport',
    position: [2, 90, 60],
    intensity: 1.2,
    color: '#ffffff'
  });

  // ------------------------------------------------------------
  // SOLAR SURFACE (VISIBLE GRID USING DECK.GL)
  // ------------------------------------------------------------

  const solarData = generateSolarSurface();

  const solarLayer = new deck.GeoJsonLayer({
    id: 'solar-layer',
    data: solarData,
    filled: true,
    stroked: false,
    opacity: 0.6,
    getFillColor: d => {
      const v = d.properties.solar;

      if (v > 1900) return [255, 69, 0, 200];
      if (v > 1750) return [255, 215, 0, 180];
      return [30, 144, 255, 150];
    }
  });

  const overlay = new deck.MapboxOverlay({
    layers: [solarLayer]
  });

  map.addControl(overlay);

});

// ------------------------------------------------------------
// Synthetic Solar Grid (CLEARLY VISIBLE)
// ------------------------------------------------------------

function generateSolarSurface() {

  const features = [];
  const step = 0.5;

  for (let lon = 19; lon <= 28; lon += step) {
    for (let lat = 34; lat <= 42; lat += step) {

      const base = 1600;
      const southBoost = (42 - lat) * 80;
      const value = base + southBoost;

      const poly = [
        [lon, lat],
        [lon + step, lat],
        [lon + step, lat + step],
        [lon, lat + step],
        [lon, lat]
      ];

      features.push({
        type: "Feature",
        properties: { solar: value },
        geometry: {
          type: "Polygon",
          coordinates: [poly]
        }
      });
    }
  }

  return { type: "FeatureCollection", features };
}

</script>
</body>
</html>
