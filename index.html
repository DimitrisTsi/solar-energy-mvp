<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Solar – Clean Working Version</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>

<style>
body { margin:0; overflow:hidden; }
#map { position:absolute; width:100vw; height:100vh; }
#deck-canvas { position:absolute; pointer-events:none; }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/deck.gl@8.9.34/dist/umd/deck.gl.js"></script>

<script>

const MAPTILER_KEY = "fmHz7ZycUzBddOZvkGZO";

// ------------------------------------------------------------
// MAP
// ------------------------------------------------------------

const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/basic-dark/style.json?key=${MAPTILER_KEY}`,
  center: [22.5, 39.0],
  zoom: 6.3,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

// ------------------------------------------------------------
// BUILDINGS
// ------------------------------------------------------------

map.on('load', () => {

  map.addLayer({
    id: '3d-buildings',
    type: 'fill-extrusion',
    source: 'openmaptiles',
    'source-layer': 'building',
    minzoom: 13,
    paint: {
      'fill-extrusion-color': '#ffffff',
      'fill-extrusion-height': [
        'case',
        ['has', 'height'], ['get', 'height'],
        ['has', 'levels'], ['*', ['get', 'levels'], 5],
        35
      ],
      'fill-extrusion-opacity': 0.95
    }
  });

  map.setLight({
    anchor: 'viewport',
    position: [2, 90, 60],
    intensity: 1.3
  });

  initSolar();

});

// ------------------------------------------------------------
// SOLAR – STANDALONE DECK
// ------------------------------------------------------------

function initSolar() {

  const points = [];

  const step = 0.15;

  for (let lon = 19; lon <= 28; lon += step) {
    for (let lat = 34; lat <= 42; lat += step) {

      const base = 1600;
      const southBoost = (42 - lat) * 80;
      const value = base + southBoost;

      points.push({
        position: [lon, lat],
        value: value
      });
    }
  }

  const deckgl = new deck.Deck({
    canvas: 'deck-canvas',
    width: '100%',
    height: '100%',
    controller: false,
    initialViewState: {
      longitude: 22.5,
      latitude: 39.0,
      zoom: 6.3,
      pitch: 60,
      bearing: -20
    },
    layers: [
      new deck.ScatterplotLayer({
        id: 'solar-layer',
        data: points,
        getPosition: d => d.position,
        getRadius: 20000,
        radiusUnits: 'meters',
        opacity: 0.5,
        getFillColor: d => {

          const min = 1600;
          const max = 2200;
          const t = (d.value - min) / (max - min);

          const r = Math.floor(30 + t * 225);
          const g = Math.floor(144 + t * 100);
          const b = Math.floor(255 - t * 200);

          return [r, g, b, 200];
        }
      })
    ]
  });

  // sync deck view with map
  map.on('move', () => {

    const center = map.getCenter();

    deckgl.setProps({
      viewState: {
        longitude: center.lng,
        latitude: center.lat,
        zoom: map.getZoom(),
        pitch: map.getPitch(),
        bearing: map.getBearing()
      }
    });

  });

}

</script>

</body>
</html>
