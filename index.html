<script>

const MAPTILER_KEY = "fmHz7ZycUzBddOZvkGZO";

const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/basic-dark/style.json?key=${MAPTILER_KEY}`,
  center: [22.5, 39.0],
  zoom: 6.2,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

map.on('load', () => {

  // ------------------------------------------------------------
  // REMOVE DEFAULT BUILDING LAYERS
  // ------------------------------------------------------------

  const layers = map.getStyle().layers;
  layers.forEach(layer => {
    if (layer['source-layer'] === 'building') {
      map.removeLayer(layer.id);
    }
  });

  // ------------------------------------------------------------
  // ADD CLEAN 3D BUILDINGS
  // ------------------------------------------------------------

  map.addLayer({
    id: 'custom-buildings',
    type: 'fill-extrusion',
    source: 'openmaptiles',
    'source-layer': 'building',
    minzoom: 13,
    paint: {
      'fill-extrusion-color': '#ffffff',
      'fill-extrusion-height': [
        'case',
        ['has', 'height'], ['get', 'height'],
        ['has', 'levels'], ['*', ['get', 'levels'], 5],
        25
      ],
      'fill-extrusion-opacity': 0.95
    }
  });

  map.setLight({
    anchor: 'viewport',
    position: [2, 90, 60],
    intensity: 1.2,
    color: '#ffffff'
  });

  // ------------------------------------------------------------
  // SOLAR HEATMAP (SMOOTH SURFACE)
  // ------------------------------------------------------------

  const solarPoints = generateSolarPoints();

  const heatmapLayer = new deck.HeatmapLayer({
    id: 'solar-heatmap',
    data: solarPoints,
    getPosition: d => [d.lon, d.lat],
    getWeight: d => d.value,
    radiusPixels: 60,
    intensity: 1,
    threshold: 0.05,
    aggregation: 'MEAN'
  });

  const overlay = new deck.MapboxOverlay({
    layers: [heatmapLayer]
  });

  map.addControl(overlay);

});

// ------------------------------------------------------------
// GENERATE SOLAR POINT FIELD
// ------------------------------------------------------------

function generateSolarPoints() {

  const points = [];

  const step = 0.2;   // resolution
  for (let lon = 19; lon <= 28; lon += step) {
    for (let lat = 34; lat <= 42; lat += step) {

      const base = 1600;
      const southBoost = (42 - lat) * 80;
      const value = base + southBoost;

      points.push({
        lon: lon,
        lat: lat,
        value: value
      });
    }
  }

  return points;
}

</script>
