<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Urban Solar – Chania (Stable Version)</title>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>

<script src="https://unpkg.com/deck.gl@8.9.34/dist.min.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
#map { width:100vw; height:100vh; }

.panel {
  position:absolute;
  background:rgba(15,15,15,0.95);
  color:#ddd;
  padding:12px;
  border-radius:4px;
  font-size:12px;
  z-index:10;
}

#legend { bottom:20px; left:20px; width:240px; }
h3 { margin:0 0 6px 0; color:#fff; font-size:14px; }

.legend-item { margin:4px 0; }
.legend-color {
  display:inline-block;
  width:14px;
  height:14px;
  margin-right:6px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="legend" class="panel">
  <h3>Solar Potential (kWh/m²/year)</h3>
  <div class="legend-item">
    <span class="legend-color" style="background:#ff7800;"></span> > 1800
  </div>
  <div class="legend-item">
    <span class="legend-color" style="background:#ffb000;"></span> 1700–1800
  </div>
  <div class="legend-item">
    <span class="legend-color" style="background:#ffe680;"></span> < 1700
  </div>
</div>

<script>

// -----------------------------------------------------------------------------
// Map Setup
// -----------------------------------------------------------------------------

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [24.018, 35.513],
  zoom: 15,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

// -----------------------------------------------------------------------------
// Generate Solar Surface
// -----------------------------------------------------------------------------

function generateSolarSurface() {
  const features = [];
  const step = 0.002;

  for (let lon = 23.99; lon <= 24.05; lon += step) {
    for (let lat = 35.49; lat <= 35.54; lat += step) {

      const base = 1700;
      const gradient = (35.54 - lat) * 200;
      const value = base + gradient + Math.random() * 40;

      const poly = [
        [lon, lat],
        [lon + step, lat],
        [lon + step, lat + step],
        [lon, lat + step],
        [lon, lat]
      ];

      features.push({
        type: "Feature",
        properties: { solar: Math.round(value) },
        geometry: { type: "Polygon", coordinates: [poly] }
      });
    }
  }

  return { type: "FeatureCollection", features };
}

const solarGeoJSON = generateSolarSurface();

// -----------------------------------------------------------------------------
// Load OSM Buildings via Overpass
// -----------------------------------------------------------------------------

async function loadBuildings() {

  const query = `
  [out:json][timeout:25];
  (
    way["building"](35.49,23.99,35.54,24.05);
  );
  out body;
  >;
  out skel qt;
  `;

  const response = await fetch(
    "https://overpass-api.de/api/interpreter",
    {
      method: "POST",
      body: query
    }
  );

  const data = await response.json();

  const nodes = {};
  data.elements.forEach(el => {
    if (el.type === "node") nodes[el.id] = [el.lon, el.lat];
  });

  const features = [];

  data.elements.forEach(el => {
    if (el.type === "way" && el.nodes) {
      const coords = el.nodes.map(id => nodes[id]).filter(Boolean);
      if (coords.length > 3) {
        features.push({
          type: "Feature",
          properties: {
            levels: el.tags?.["building:levels"]
              ? parseInt(el.tags["building:levels"])
              : 2
          },
          geometry: {
            type: "Polygon",
            coordinates: [coords]
          }
        });
      }
    }
  });

  return {
    type: "FeatureCollection",
    features
  };
}

// -----------------------------------------------------------------------------
// Deck Layers
// -----------------------------------------------------------------------------

let overlay = null;

async function initLayers() {

  const buildings = await loadBuildings();

  const solarLayer = new deck.GeoJsonLayer({
    id: 'solar',
    data: solarGeoJSON,
    filled: true,
    stroked: false,
    getFillColor: d => {
      const v = d.properties.solar;
      if (v > 1800) return [255,120,0,180];
      if (v > 1700) return [255,176,0,160];
      return [255,230,120,140];
    }
  });

  const buildingLayer = new deck.GeoJsonLayer({
    id: 'buildings',
    data: buildings,
    extruded: true,
    wireframe: false,
    filled: true,
    getElevation: d => d.properties.levels * 3,
    getFillColor: [100,100,100,200]
  });

  overlay = new deck.MapboxOverlay({
    layers: [solarLayer, buildingLayer]
  });

  map.addControl(overlay);
}

map.on('load', initLayers);

</script>
</body>
</html>
